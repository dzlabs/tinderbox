#!/bin/sh -T

pb=$0
[ -z "$(echo "${pb}" | sed 's![^/]!!g')" ] && \
pb=$(type "$pb" | sed 's/^.* //g')
pb=$(realpath $(dirname $pb))
pb=${pb%%/scripts}

. ${pb}/scripts/tinderbox_shlib.sh

TINDERBUILD_ARGS="$*"
TINDERD_SLEEPTIME=$(parse_rawenv -t raw -a TINDERD_SLEEPTIME -q)
TINDERD_SLEEPTIME=${TINDERD_SLEEPTIME:=120}

main_loop() {
	while true ; do
    		trap "" 1
		ENTRY=$(${pb}/scripts/tc listBuildPortsQueue -r 2>/dev/null | head -1)
		ID=${ENTRY%:*}
		BUILD=${ENTRY#*:}
		BUILD=${BUILD%:*}
		PORT=${ENTRY##*:}

		if [ -n "${BUILD}" -a -n "${PORT}" -a -n "${ID}" ] ; then
			echo "Going to build ${PORT} on ${BUILD}"
			${pb}/scripts/tc addPort -b ${BUILD} -d ${PORT} -r
			${pb}/scripts/tinderbuild -b ${BUILD} ${TINDERBUILD_ARGS} ${PORT} >/dev/null
			${pb}/scripts/tc rmBuildPortsQueueEntry -i ${ID}
		else
			echo "INFO: Nothing to do. Sleeping ${TINDERD_SLEEPTIME} seconds."
			trap main_loop 1
			sleep ${TINDERD_SLEEPTIME}
		fi
	done
}

main_loop
