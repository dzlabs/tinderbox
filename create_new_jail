#!/bin/sh

usage () {
    echo "usage: $0 -n <jail name> -t <jail tag> [-d <description>] [-u <update command|CVSUP|NONE>]"
    exit 1
}

pb=/space
suphost=cvsup12.FreeBSD.org
cvsup_compress= #*default compress

args=$(getopt n:t:u:d: $*)

if [ $? != 0 ]; then
    usage
fi

jail_name=""
jail_tag=""
descr=""
update_cmd=""
uc=""

set -- $args

for i; do
    case "$i" in
	-n)
	  jail_name="$2"; shift;
	  shift;;
	-t)
	  jail_tag="$2"; shift;
	  shift;;
	-d)
	  descr="$2"; shift;
	  shift;;
	-u)
	  update_cmd="$2"; shift;
	  shift;;
	--)
	  shift; break;;
    esac
done

if [ -z "${jail_name}" -o -z "${jail_tag}" ]; then
    usage
fi

_jails=$(${pb}/scripts/tc listJails)
if echo ${_jails} | grep -qw ${jail_name}; then
    echo "ERROR: Jail, \"${jail_name}\" already exists."
    exit 1
fi

if [ -z "${update_cmd}" ]; then
    update_cmd="/usr/local/bin/cvsup -g ${pb}/jails/${jail_name}/src-supfile"
elif [ "${update_cmd}" = "NONE" ]; then
    update_cmd=""
    uc="-u NONE"
else
    uc="-u ${update_cmd}"
fi

echo -n "INFO: Creating directories and supfile for new jail..."
rm -rf ${pb}/jails/${jail_name}

mkdir -p ${pb}/jails/${jail_name}/src

cat > ${pb}/${jail_name}/src-supfile << EOSF
*default host=${suphost}
*default base=${pb}/${jail_name}
*default prefix=${pb}/${jail_name}
*default release=cvs tag=${jail_tag}
*default delete use-rel-suffix
${cvsup_compress}
src-all
EOSF

echo "DONE."

# Add the new jail to the datastore.
echo -n "INFO: Adding jail to datastore..."
if [ ! -z "${descr}" ]; then
    descr="-d ${descr}"
fi
${pb}/scripts/tc addJail -n ${jail_name} -t ${jail_tag} ${descr} ${uc}

if [ $? != 0 ]; then
    echo "FAILED."
    exit 1
fi

echo "DONE."

echo "INFO: Initializing new jail..."
${pb}/scripts/mkjail ${jail_name}

if [ $? != 0 ]; then
    echo "FAILED."
    exit 1
fi

echo "DONE."

exit 0
